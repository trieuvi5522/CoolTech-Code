//This is template code for Shelly Plus 2PM read sensor value and Input/Output state and peroidly send to MQTT broker
// ===== CONFIG =====
let CONFIG = {
 interval_s: 30, // read interval in seconds
 mqtt_topic: "/shelly/test",
 qos: 0,
 retain: false
};
// ensure minimum interval is 2 seconds
if (CONFIG.interval_s < 2) {
 CONFIG.interval_s = 2;
}
// ===== MAIN FUNC =====
function readAndPublishSensors() {
 Shelly.call(
 "Shelly.GetStatus",
 {},
 function (res, err_code, err_msg, ud) {
 if (err_code !== 0 || !res) {
 return;
 }
 let filtered = {
 input: {},
 temperature: {}
 };
 // keep only input:* and temperature:* components
 for (let k in res) {
 // keys like "input:0", "input:1"
 if (k.indexOf("input:") === 0) {
 filtered.input[k] = res[k];
 }
 // keys like "temperature:100", "temperature:101", ...
 else if (k.indexOf("temperature:") === 0) {
 filtered.temperature[k] = res[k];
 }
 }
 let payload = JSON.stringify(filtered);
 MQTT.publish(CONFIG.mqtt_topic, payload, CONFIG.qos,
CONFIG.retain);
 },
 null
 );
}
// set periodic timer
Timer.set(CONFIG.interval_s * 1000, true, readAndPublishSensors,
null);
// initial call on script start
readAndPublishSensors();
